!function(e){var t={};function s(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(r,n,function(t){return e[t]}.bind(null,n));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=8)}([function(e,t,s){"use strict";s.d(t,"a",function(){return r});const r={PHASE_COMPLETION_READY:"phase_completion_ready",PHASE_COMPLETION_NOT_READY:"phase_completion_not_ready",PHASE_CHANGED:"phase_changed",QUESTION_ANSWERED:"question_answered",QUESTION_NOT_ANSWERED:"question_not_answered",OPTION_VALUE_CHANGED:"answer_value_changed",BUG_REPORT_SUCCEEDED:"bug_report_succeeded",BUG_REPORT_FAILED:"bug_report_failed",USER_REJECTED:"user_rejected"}},function(e,t,s){"use strict";s.d(t,"a",function(){return r});class r{constructor(e){this.name=e,this.followsUpOn=null,this.autoComplete=!1}setFollowsUpOn(e){return this.followsUpOn=e,this}setAutoComplete(e){return this.autoComplete=e,this}getType(){throw Error("notimplemented")}start(){throw Error("not implemented")}checkCompletionReady(){throw Error("not implemented")}getThingsToFollowUpOn(){throw Error("not implemented")}getSummary(){throw Error("not implemented")}}},function(e,t,s){"use strict";s.d(t,"a",function(){return r});const r={ATTEMPT:"attempt",QUESTION:"question",REPORT:"report"}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",function(){return ProcessFactory});var _src_Models_Debug_DebugProcess_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4),_src_Models_Debug_Build_PhaseFactory_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(6),_src_Models_Debug_BugReporter_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(7),_src_Models_Debug_PhaseReport_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(5);function lazyEvalUsingParent(parentPhase){return str=>()=>{let parentResult=parentPhase.result;return eval(str)}}class ProcessFactory{constructor(e){this.phaseFactory=new _src_Models_Debug_Build_PhaseFactory_js__WEBPACK_IMPORTED_MODULE_1__.a(e)}create(e,t,s){let r=new _src_Models_Debug_DebugProcess_js__WEBPACK_IMPORTED_MODULE_0__.a(e);for(let e of t.phases)r.enqueuePhase(this.createPhase(e));if(s){let e=new _src_Models_Debug_BugReporter_js__WEBPACK_IMPORTED_MODULE_2__.a(r);r.enqueuePhase(_src_Models_Debug_PhaseReport_js__WEBPACK_IMPORTED_MODULE_3__.a.create(e))}return r}createPhase(e,t){let s=this.phaseFactory.create(e,t);return this.addFollowUpPhasesForSuccess(s,e),this.addFollowUpPhasesForAnswers(s,e),s}addFollowUpPhasesForSuccess(e,t){if("PhaseAttempt"===t.type&&t.success)for(let s of t.success){let t=this.createPhase(s,lazyEvalUsingParent(e));e.addSuccessFollowUp(t)}}addFollowUpPhasesForAnswers(e,t){if("PhaseQuestion"===t.type)for(let[s,r]of Object.entries(t.questions))if("QuestionSelect"===r.type)for(let[t,n]of Object.entries(r.options))if(n.followUp)for(let r of n.followUp){let n=e.questions[s].options[t],o=this.createPhase(r,lazyEvalUsingParent(e));n.addFollowUp(o)}}}},function(e,t,s){"use strict";s.d(t,"a",function(){return n});var r=s(0);class n{constructor(e){this.name=e,this.phases=[],this.currentPhaseIndex=-1}enqueuePhase(e){return this.phases.push(e),this.watchPhase(e),this}insertPhase(e){return this.phases.splice(this.currentPhaseIndex+1,0,e),this.watchPhase(e),this}watchPhase(e){let t=[r.a.PHASE_COMPLETION_READY,r.a.PHASE_COMPLETION_NOT_READY,r.a.PHASE_CHANGED];$(e).on(t.join(" "),e=>$(this).trigger(e.type,e)),$(e).on(r.a.PHASE_COMPLETION_READY,()=>{e.autoComplete&&this.goToNextPhase()})}start(){this.currentPhaseIndex=-1,this.goToNextPhase()}goToNextPhase(){if(this.currentPhaseIndex>=0)for(let e of this.getCurrentPhase().getThingsToFollowUpOn())for(let t of e.followUpPhases)this.insertPhase(t);if(!this.hasNextPhase())throw Error("there's no next phase");this.currentPhaseIndex++,$(this).trigger(r.a.PHASE_CHANGED),this.getCurrentPhase().checkCompletionReady(),this.getCurrentPhase().start()}hasNextPhase(){return this.currentPhaseIndex<this.phases.length-1}getCurrentPhase(){return this.phases[this.currentPhaseIndex]}getSummarySoFar(){return this.phases.slice(0,this.currentPhaseIndex).map(e=>e.getSummary())}static create(e){return new n(e)}}},function(e,t,s){"use strict";s.d(t,"a",function(){return a});var r=s(1),n=s(0),o=s(2);const i={SUCCESS:"success",FAIL:"fail",NOT_ATTEMPTED:"not_attempted"};class a extends r.a{constructor(e){super("send bug report"),this.bugReporter=e,this.status=i.NOT_ATTEMPTED,this.error}getType(){return o.a.REPORT}start(){let e=this.bugReporter.buildReport();this.bugReporter.submitReport(e).then(e=>{this.status=i.SUCCESS,$(this).trigger({type:n.a.BUG_REPORT_SUCCEEDED,url:e.html_url})}).catch(e=>{this.error=e,this.status=i.FAIL,$(this).trigger(n.a.BUG_REPORT_FAILED)}).finally(()=>this.checkCompletionReady())}checkCompletionReady(){this.status!==i.NOT_ATTEMPTED?$(this).trigger(n.a.PHASE_COMPLETION_READY):$(this).trigger(n.a.PHASE_COMPLETION_NOT_READY)}getThingsToFollowUpOn(){return[]}getSummary(){return{phaseName:this.name}}static create(e){return new a(e)}}},function(e,t,s){"use strict";var r=s(1),n=s(0),o=s(2);const i={SUCCESS:"success",FAIL:"fail",NOT_ATTEMPTED:"not_attempted"};class a extends r.a{constructor(e,t){super(e),this.instructions,this.attempt=t,this.success=(async()=>{}),this.fail=(async()=>{}),this.status=i.NOT_ATTEMPTED,this.autoComplete=!0,this._error,this._result,this.summarizeData=(e=>e),this.ctrl={},this.successFollowUpPhases=[]}getType(){return o.a.ATTEMPT}get result(){if(this.status===i.NOT_ATTEMPTED)throw new Error("tried to get result before the attempt settled");if(this.status===i.FAIL)throw new Error("tried to get result of an attempt that failed");return this._result}async doAttempt(){try{let e=await this.abortableAttempt();this.status=i.SUCCESS,this._result=e,await this.success(e)}catch(e){console.warn(e),this.status=i.FAIL,this._error=e,await this.fail(e)}this.checkCompletionReady()}async abortableAttempt(){return new Promise(async(e,t)=>{$(this.ctrl).on(n.a.USER_REJECTED,()=>t("user rejected"));try{let s;this.followsUpOn&&(s=this.followsUpOn.result),e(await this.attempt(s,this.ctrl))}catch(e){t(e)}})}userAbort(){$(this.ctrl).trigger(n.a.USER_REJECTED)}setInstructions(e){return this.instructions=e,this}setDataSummarizer(e){return this.summarizeData=e,this}onSuccess(e){return this.success=e,this}addSuccessFollowUp(e){return this.successFollowUpPhases.push(e),e.setFollowsUpOn(this),this}get followUpPhases(){return this.status===i.SUCCESS?this.successFollowUpPhases:[]}onFail(e){return this.fail=e,this}start(){this.doAttempt()}checkCompletionReady(){this.status!==i.NOT_ATTEMPTED?$(this).trigger(n.a.PHASE_COMPLETION_READY):$(this).trigger(n.a.PHASE_COMPLETION_NOT_READY)}getThingsToFollowUpOn(){return[this]}getSummary(){return{phaseName:this.name,status:this.status,data:void 0===this._result?this._result:this.summarizeData(this._result),error:this.summarizeError()}}summarizeError(){let e=this._error;return e instanceof Error?{message:e.message,name:e.name,extra:e.extra,stack:e.stack}:e}static create(e,t){return new a(e,t)}}class c extends r.a{constructor(e){super(e),this.questions=[],this._examinedHtml}getType(){return o.a.QUESTION}lookAt(e){return this._examinedHtml=e,this}get examinedHtml(){return"function"==typeof this._examinedHtml?this._examinedHtml():this._examinedHtml}addQuestion(e){return this.questions.push(e),$(e).on(n.a.QUESTION_ANSWERED,()=>{this.checkCompletionReady()}),$(e).on(n.a.QUESTION_NOT_ANSWERED,()=>{this.checkCompletionReady()}),this}start(){}checkCompletionReady(){for(let e of this.questions)if(!e.isAnswered())return void $(this).trigger(n.a.PHASE_COMPLETION_NOT_READY);$(this).trigger(n.a.PHASE_COMPLETION_READY)}getThingsToFollowUpOn(){return this.questions.reduce((e,t)=>e.concat(t.getThingsToFollowUpOn()),[])}getSummary(){return{phaseName:this.name,questions:this.questions.map(e=>e.getSummary())}}static create(e){return new c(e)}}const l={VALUE:"value",FREE_FORM:"free_form",SELECT:"select"};class u{constructor(e){this.text=e,this.options=[],this.selectedOptionIndex=null}getType(){throw Error("not implemented")}addOption(e){return this.options.push(e),this}setSelectedOption(e){return this.selectedOptionIndex=e,$(this).trigger(n.a.QUESTION_ANSWERED),this}isAnswered(){return null!==this.selectedOptionIndex}getSelectedOption(){return this.options[this.selectedOptionIndex]}getThingsToFollowUpOn(){let e=this.getSelectedOption();return e.followUpPhases.length>0?[e]:[]}getSummary(){return{question:this.text,answer:this.getSelectedOption().value}}static create(e){return new u(e)}}class p extends u{getType(){return l.SELECT}static create(e){return new p(e)}}class h{constructor(e,t,s=""){this.text=e,this.value=t,this.className=s,this.followUpPhases=[]}addFollowUp(e){return this.followUpPhases.push(e),e.setFollowsUpOn(this),this}setValue(e){this.value=e,$(this).trigger(n.a.OPTION_VALUE_CHANGED)}static create(e,t,s){return new h(e,t,s)}}class d extends u{constructor(e,t,s=0){super(e),this.minResponseLength=s,this.options=[h.create(t,"","free-form")],this.setSelectedOption(0),this.watchSelectedOption()}getType(){return l.FREE_FORM}watchSelectedOption(){$(this.getSelectedOption()).on(n.a.OPTION_VALUE_CHANGED,()=>{this.isAnswered()?$(this).trigger(n.a.QUESTION_ANSWERED):$(this).trigger(n.a.QUESTION_NOT_ANSWERED)})}isAnswered(){return super.isAnswered()&&this.options[0].value.length>=this.minResponseLength}static create(e,t,s){return new d(e,t,s)}}const g={CORRECT:"correct",INCORRECT:"incorrect",NOT_SURE:"not_sure"},f=1;class m extends u{constructor(e,t){super(e),this._valueQuestioned=t,this.options=[h.create("Correct",g.CORRECT,"correct"),h.create("Incorrect",g.INCORRECT,"incorrect"),h.create("Not sure",g.NOT_SURE,"not-sure")]}get value(){return"function"==typeof this._valueQuestioned?this._valueQuestioned():this._valueQuestioned}getType(){return l.VALUE}addFollowUp(e){return this.options[f].addFollowUp(e),this}getSummary(){return Object.assign(super.getSummary(),{valueChecked:this.value})}static create(e,t){return new m(e,t)}}class _{create(e,t){switch(e.type){case"QuestionFreeForm":return this.createQuestionFreeForm(e);case"QuestionSelect":return this.createQuestionSelect(e);case"QuestionValue":return this.createQuestionValue(e,t);default:throw`unrecognized question type: ${e.type}`}}createQuestionFreeForm(e){let t=e.minResponseLength||0;return d.create(e.ask,e.placeholderText,t)}createQuestionSelect(e){let t=p.create(e.ask);for(let s of e.options)t.addOption(h.create(s.answer,s.value));return t}createQuestionValue(e,t){let s=t(e.examine);return m.create(e.ask,s)}}s.d(t,"a",function(){return w});class w{constructor(e){this.actions=e,this.questionFactory=new _}create(e,t){switch(e.type){case"PhaseAttempt":return this.createPhaseAttempt(e);case"PhaseQuestion":return this.createPhaseQuestion(e,t);case"PhaseReport":return this.createPhaseReport(e);default:throw Error(`unrecognized phase type ${e.type}`)}}createPhaseAttempt(e){let t=this.actions[e.action];if(void 0===t)throw Error(`unrecognized action: ${e.action}`);let s=a.create(e.internalName,t.execute);return t.summarizeResult&&s.setDataSummarizer(t.summarizeResult),e.instructions&&s.setInstructions(e.instructions),s}createPhaseQuestion(e,t){let s=c.create(e.internalName);e.lookAt&&s.lookAt(t(e.lookAt));for(let r of e.questions){let e=this.questionFactory.create(r,t);s.addQuestion(e)}return s}}},function(e,t,s){"use strict";class r{constructor(e){this.process=e,this.censoredProps=new Set(["csrf","birthdate"])}getCollectibleData(){return this.scrub(this.buildData())}buildData(){let e=window.navigator;return{process:this.process.getSummarySoFar(),contentHtml:document.getElementById("contentContainer").outerHTML,navigator:{appCodeName:e.app,appName:e.appName,appVersion:e.appVersion,platfrom:e.platfrom,userAgent:e.userAgent,languages:$.extend(!0,[],e.languages),oscpu:e.oscpu},gameData:$.extend(!0,{},window.game_data)}}scrub(e){if("object"==typeof e&&null!==e)for(let t of Object.keys(e))this.censoredProps.has(t)?e[t]="CENSORED":e[t]=this.scrub(e[t]);return"string"==typeof e?this.censorCsrfInString(e):e}censorCsrfInString(e){return e.replace(/((&|&amp;)h=)(\w+)/g,"$1CENSORED").replace(/(\?h=)(\w+)(&|&amp;)/g,"$1CENSORED$3").replace(/(csrf_token = ')(\w+)/g,"$1CENSORED").replace(/("csrf":")(\w+)/g,"$1CENSORED")}}let n={bugReport:{url:"https://56hqsw3c2c.execute-api.us-east-2.amazonaws.com/prod/bugreport"}};s.d(t,"a",function(){return o});class o{constructor(e){this.process=e}buildReport(){return{title:"[Bug report] "+this.process.name,dataCollected:new r(this.process).getCollectibleData()}}async submitReport(e){let t=["|game version|world|player|twcheese|","|---|---|---|---|",`|${game_data.majorVersion}|${game_data.world}|${game_data.player.name}|${window.TwCheese.version}|`,"```"+JSON.stringify(e.dataCollected,null,2)+"```"].join("\n");return await this.createIssue(e.title,t)}async createIssue(e,t){let s=await fetch(n.bugReport.url,{method:"POST",body:JSON.stringify({title:e,message:t})});if(!s.ok)throw new Error(`Failed to create issue. [${s.status}: ${s.statusText}]`);return await s.json()}}},function(e,t,s){"use strict";s.r(t);class r{constructor(e){this.id=e,this.props={},this._loadCachedData()}get(e,t){return function(e,t,s){let r=t.split(".");for(let t=0;t<r.length-1;t++){let n=r[t];if("object"!=typeof e[n]||null===n)return s;e=e[n]}let n=e[r[r.length-1]];return void 0===n?s:n}(this.props,e,t)}set(e,t){!function(e,t,s){let r=t.split(".");for(let t=0;t<r.length-1;t++){let s=r[t];"object"==typeof e[s]&&null!==s||(e[s]={}),e=e[s]}e[r[r.length-1]]=s}(this.props,e,t),this._save()}initProps(e){this.props=e}_loadCachedData(){let e=window.localStorage.getItem(this.id);if(e){let t=JSON.parse(e);return this.props=t.props||t,t}return null}_save(){this._beforeSave(),window.localStorage.setItem(this.id,JSON.stringify(this._getCacheableData()))}_beforeSave(){}_getCacheableData(){return{props:this.props}}}let n=new class{constructor(e){this.maxBurstsPerSecond=e,this.recentRequests=new Array(e)}requestWasMade(){this.recentRequests.unshift(performance.now()),this.recentRequests.pop()}async sleepIfNeeded(){let e=this.recentRequests[this.maxBurstsPerSecond-1];if(void 0===e)return;let t=e+1e3-performance.now();return t<=0?void 0:new Promise(function(e,s){setTimeout(e,t)})}}(5),o=window.fetch;window.fetch=function(){return n.requestWasMade(),o.apply(this,arguments)};class i extends r{setUrl(e){return this.url=e,this}setTtl(e){return this.ttl=1e3*e,this}async ensureUpdated(){this.needsUpdate()&&await this.update()}needsUpdate(){let e=(new Date).getTime(),t=this.ttl||86400;return!this.timeUpdated||t<e-this.timeUpdated}async update(){let e=await async function(e){await n.sleepIfNeeded();let t=await fetch(e),s=await t.text(),r=(new DOMParser).parseFromString(s,"text/xml");return Object.defineProperty(r,"URL",{get:()=>e}),r}(this.url);this._processXml(e),this._save()}_processXml(e){this.props=function e(t){if(0===t.children.length)return parseFloat(t.innerHTML)||null;let s={};for(let r of t.children)s[r.tagName]=e(r);return s}(e).config}_loadCachedData(){let e=super._loadCachedData();e&&(this.timeUpdated=e.timeUpdated)}_beforeSave(){this.timeUpdated=(new Date).getTime()}_getCacheableData(){return Object.assign({},super._getCacheableData(),{timeUpdated:this.timeUpdated})}}let a=new r("twcheese.userConfig"),c=new i("twcheese.gameConfig").setUrl(`https://${document.domain}/interface.php?func=get_config`).setTtl(28800),l=new i("twcheese.buildingConfig").setUrl(`https://${document.domain}/interface.php?func=get_building_info`).setTtl(28800),u=new i("twcheese.troopConfig").setUrl(`https://${document.domain}/interface.php?func=get_unit_info`).setTtl(28800);let p=window.image_base,h=window.TwCheese.ROOT+"/assets/images/",d={plus:p+"plus.png",minus:p+"minus.png",wood:p+"holz.png",stone:p+"lehm.png",iron:p+"eisen.png",attack:p+"command/attack.png",haulPartial:p+"max_loot/0.png",haulFull:p+"max_loot/1.png",info:p+"questionmark.png",attackSentViaFa:p+"command/farm.png",attackSizeSmall:p+"command/attack_small.png",attackSizeMedium:p+"command/attack_medium.png",attackSizeLarge:p+"command/attack_large.png",attackContainsSnob:p+"command/snob.png",attackContainsSpy:p+"command/spy.png",attackContainsKnight:p+"command/knight.png",popupBackground:p+"popup/content_background.png",popupBorder:p+"popup/border.png",servant:p+"paladin_new.png",loadingSpinner:p+"throbber.gif",calendar:h+"calendar.png",sidebarMain:h+"sidebar/gear.png",sidebarBug:h+"sidebar/bug.png",sidebarGithub:h+"sidebar/github.png",jq:{blue:h+"jquery/ui-icons_2e83ff_256x240.png",black:h+"jquery/ui-icons_222222_256x240.png",darkGrey:h+"jquery/ui-icons_454545_256x240.png",grey:h+"jquery/ui-icons_888888_256x240.png",red:h+"jquery/ui-icons_cd0a0a_256x240.png"},legacy:{helpBackground:h+"legacy/help_background.png",helpBackgroundBright:h+"legacy/help_background_highlight.png"},buildingIcon:e=>p+`buildings/${e}.png`,troopIcon:e=>p+`unit/unit_${e}.png`,dotIcon:e=>p+`dots/${e}.png`,scavengeOption:e=>p+`scavenging/options/${e}.png`};let g=new Set;function f(e){g.has(e)||($(`<style>${e}</style>`).appendTo("head"),g.add(e))}f(`\n    .twcheese-popup {\n        z-index: 13000;\n        display: block;\n        position: fixed;\n        top: 60px;\n        border: 19px solid #804000;\n        border-image: url(${d.popupBorder}) 19 19 19 19 repeat;\n        left: 50%;\n        -webkit-transform: translateX(-50%);\n        transform: translateX(-50%);\n    }\n`);new Set(["click","mousemove","mouseover","mouseout","mousedown","mouseup"]),new Set(["mousenter","mouseleave","mouseover","mouseout"]);function m(e){return"suggestRedirect.skip."+e}f("\n    .twcheese-suggest-redirect-skip-container {\n        margin-top: 20px;\n        font-size: 10px;\n    }\n\n    .twcheese-suggest-redirect-skip-container > * {\n        vertical-align: middle;\n    }\n");class _{constructor(e){this.base=e,this.id=e.id}getName(){return this.base.name}getLootPercent(){return 100*this.base.loot_factor}getLootFactor(){return this.base.loot_factor}calcDurationSeconds(e){let t=e**2*this.getLootPercent()*this.base.loot_factor,s=Math.pow(t,this.base.duration_exponent)+this.base.duration_initial_seconds;return Math.round(s*this.base.duration_factor)}calcTargetCapacity(e){let t=(e/this.base.duration_factor-this.base.duration_initial_seconds)**(1/this.base.duration_exponent);return Math.round(Math.sqrt(t/this.getLootPercent()/this.base.loot_factor))}}let w=["spear","sword","axe","archer","spy","light","marcher","heavy","ram","catapult","knight","snob","militia"];function b(e){let t=u.get(e);return void 0===t?0:t.speed}function T(e){let t=u.get(e);return void 0===t?0:t.carry}class E{constructor(){for(let e of w)this[e]=0}clone(){return Object.assign(new E,this)}filter(e){let t=new E;for(let s of w)e.includes(s)&&(t[s]=this[s]);return t}isZero(){for(let e of Object.values(this))if(0!==e)return!1;return!0}sum(){let e=0;for(let t of Object.values(this))e+=t;return e}each(e){for(let t of w){e(t,this[t])}}carryCapacity(){let e=0;for(let t of w)e+=this[t]*T(t);return e}populationUsed(){return w.reduce((e,t)=>e+function(e){let t=u.get(e);return void 0===t?0:t.pop}(t)*this[t],0)}travelDuration(e,t="attack"){return O(this.travelMinutesPerField(t),e)}travelMinutesPerField(e="attack"){if("support"===e&&this.knight>0)return b("knight");let t=w.filter(e=>this[e]>0).map(e=>b(e));return Math.max(...t)}subtract(e){let t=new E;for(let[s,r]of Object.entries(this))t[s]=r-e[s];return t}zeroNegatives(){let e=new E;for(let[t,s]of Object.entries(this))e[t]=Math.max(0,s);return e}toArray(){return w.map(e=>this[e])}static fromArray(e){let t=new E;return e.forEach((e,s)=>{t[w[s]]=e}),t}}function O(e,t){return 1e3*Math.round(t*e*60)}let v={troopTypesOnWorld:()=>window.game_data.units,existsOnWorld:e=>void 0!==u.get(e),countToCarry(e,t,s=0){let r=t/(T(e)*(100+s)/100);return Math.round(10*r)/10},carryCapacity:(e,t=1)=>T(e)*t,travelDuration:(e,t)=>O(b(e),t)};function y(e){let t=function(e){let t=function(e){let t=e.getElementsByTagName("script");for(let e of t){let t=e.innerHTML;if(t.includes("new ScavengeScreen"))return t}}(e),s=function(e){let t,s=e.indexOf("{"),r=S(e,s,"{","}"),n=s+r.length;for(;n<e.length;n++)if("{"===e[n]){t=S(e,n,"{","}");break}return{optionsConfig:JSON.parse(r),troops:JSON.parse(t)}}(function(e){let t=e.indexOf("new ScavengeScreen")+"new ScavengeScreen".length;return S(e,t,"(",")")}(t)),r=function(e){let t=e.indexOf("var village = ")+"var village = ".length;return S(e,t,"{","}")}(t);return{optionsConfig:s.optionsConfig,troops:s.troops,village:JSON.parse(r)}}(e),s=t.optionsConfig,r=new Map;for(let e of Object.keys(s))r.set(parseInt(e),new _(s[e]));return{options:r,sendableTroopTypes:Object.keys(t.troops),haulFactor:t.village.unit_carry_factor}}function S(e,t,s="(",r=")"){let n=1,o=0,i=-1;for(let a=t+1;a<e.length;a++){let c=e[a];if(c===s&&n++,c===r&&(o++,i=a),o===n)return e.substring(t,i+1)}}class P{constructor(e){this._sendableTroopTypes=e,this.reset()}reset(){this.mode=P.MODE_SANE_PERSON,this.allowedOptionIds=new Set([1,2,3,4]),this.targetDurationSeconds=7200,this.initTroops(),this.troopOrder=[["axe","light","marcher"],["spear","sword","archer"],["heavy"],["knight"]]}initTroops(){this.troops={};for(let e of this._sendableTroopTypes)this.troops[e]={maySend:!0,reserved:0}}setMode(e){this.mode=e,$(this).trigger("change")}isOptionAllowed(e){return this.allowedOptionIds.has(e)}setOptionAllowed(e,t=!0){t?this.allowedOptionIds.add(e):this.allowedOptionIds.delete(e),$(this).trigger("change")}setTargetDuration(e){this.targetDurationSeconds=e,$(this).trigger("change")}getAllowedTroopTypes(){return this._sendableTroopTypes.filter(e=>this.troops[e].maySend)}isTroopTypeAllowed(e){return this.troops[e].maySend}setTroopAllowed(e,t){this.troops[e].maySend=t,$(this).trigger("change")}getReservedTroopCounts(){let e=new E;for(let t of this._sendableTroopTypes)e[t]=this.troops[t].reserved;return e}getReservedCount(e){return this.troops[e].reserved}setReservedCount(e,t){this.troops[e].reserved=t,$(this).trigger("change")}setTroopOrder(e){this.troopOrder=e,$(this).trigger("change")}export(){return{mode:this.mode,allowedOptionIds:[...this.allowedOptionIds.values()],targetDurationSeconds:this.targetDurationSeconds,troops:this.troops,troopOrder:this.troopOrder}}import(e){this.mode=e.mode,this.allowedOptionIds=new Set(e.allowedOptionIds),this.targetDurationSeconds=e.targetDurationSeconds,this.troops=e.troops,this.troopOrder=e.troopOrder}}P.MODE_SANE_PERSON="sane_person",P.MODE_ADDICT="addict";class C{constructor(e,t,s){this.options=e,this.sendableTroopTypes=t,this.troopUtil=s,this.preferences=new P(t)}adjustAvailableTroopCounts(e){return e.filter(this.preferences.getAllowedTroopTypes()).subtract(this.preferences.getReservedTroopCounts()).zeroNegatives()}adjustUsableOptionIds(e){return e.filter(e=>this.preferences.isOptionAllowed(e))}areTroopsSufficient(e){return(e=this.adjustAvailableTroopCounts(e)).populationUsed()>=10}assignTroops(e,t,s=1){return e=this.adjustUsableOptionIds(e),t=this.adjustAvailableTroopCounts(t),this.preferences.mode===P.MODE_ADDICT?this.assignTroopsForAddict(e,t,s):this.assignTroopsForSanePerson(e,t,s)}assignTroopsForSanePerson(e,t,s=1){let r=new Map,n=[...this.options.keys()].reverse();for(let o of n){let n;if(e.includes(o)){let e=this.options.get(o).calcTargetCapacity(this.preferences.targetDurationSeconds);n=this.chunkTroopsToHaul(e,t,s)}else n=new E;r.set(o,n),t=t.subtract(n)}return r}assignTroopsForAddict(e,t,s=1){let r=new Map,n=[...this.options.keys()].reverse(),o=t.carryCapacity()*s,i=this.preferences.targetDurationSeconds,a=0,c={},l=0;for(let t of n){if(!e.includes(t))continue;let s=this.options.get(t);c[t]=1/s.getLootFactor(),l+=c[t],a+=s.calcTargetCapacity(i)}let u=Math.min(1,a/o);for(let i of n){let n;if(e.includes(i)){let e=u*(c[i]/l)*o;n=this.chunkTroopsToHaul(e,t,s)}else n=new E;r.set(i,n),t=t.subtract(n)}return r}chunkTroopsToHaul(e,t,s=1){let r=new E,n={};for(let o of this.preferences.troopOrder){if(e<0)break;let i=0;for(let e of o){let r=t[e];n[e]=this.troopUtil.carryCapacity(e,s),i+=r*n[e]}let a=Math.min(1,e/i);for(let s of o){let o=t[s];r[s]=Math.floor(o*a),e-=r[s]*n[s]}e>0&&this.troopsToTopOff(e,t,r,o,n).each(function(t,s){e-=s*(n[t]||0),r[t]+=s})}return r}troopsToTopOff(e,t,s,r,n){let o=new E;for(;e>0;){let i=!1,a=null,c=Number.MAX_SAFE_INTEGER;for(let l of r)if(t[l]>s[l]+o[l]){i=!0;let t=Math.abs(e-n[l]);t<c&&(c=t,a=l)}if(!i)break;if(e<Math.abs(e-n[a]))break;o[a]+=1,e-=n[a]}return o}}class A{insertBefore(e){return this._beforeInsert(),$(e).before(this.$el),this}insertAfter(e){return this._beforeInsert(),$(e).after(this.$el),this}appendTo(e){return this._beforeInsert(),$(e).append(this.$el),this}_beforeInsert(){if("function"!=typeof this.afterInsert)return;!function(e,t){let s=new MutationObserver(r=>{e:for(let n of r)for(let r of n.addedNodes)if(r===e||r.contains(e)){setTimeout(t,0),s.disconnect();break e}});s.observe(document,{attributes:!0,childList:!0,subtree:!0})}(this.$el[0],()=>this.afterInsert())}}class D extends A{constructor(e,t,s){super(),this.preferences=e,this.scavengeOptions=t,this.sendableTroopTypes=s,this.initStructure(),this.initTroopOrder(),this.watchSelf()}initStructure(){this.$el=$(this.createHtml().trim()),this.$targetDuration=this.$el.find(".target-duration"),this.$options=this.$el.find(".options-section input"),this.$modes=this.$el.find("input[name='mode']"),this.$troopsAllowed=this.$el.find(".troop-allowed"),this.$troopsReserved=this.$el.find(".troop-reserved"),this.$troopGroups=this.$el.find(".troop-group")}createHtml(){return`<div class="twcheese-scavenge-preferences-widget">\n            <h3>Preferences</h3>\n            ${this.createTimingSectionHtml()}\n            <br/>\n            ${this.createOptionsSectionHtml()}\n            <br/>\n            <table style="width: 100%;">\n                <tr>\n                    <td>${this.createTroopsSectionHtml()}</td>\n                    <td style="width: 20px;"></td>\n                    <td>${this.createTroopsOrderSectionHtml()}</td>\n                </tr>\n            </table>\n        </div>`}createTimingSectionHtml(){let e=this.preferences.targetDurationSeconds,t=Math.floor(e/3600),s=String(Math.floor(e/60)%60).padStart(2,"0"),r=this.preferences.mode,n=P.MODE_SANE_PERSON,o=P.MODE_ADDICT;return`\n            <table class="vis timing-section">\n                <tr><th>Timing</th></tr>\n                <tr>\n                    <td>\n                        Target duration:\n                        <input type="text" class="target-duration" value="${t}:${s}" placeholder="2:00" required pattern="\\d+:\\d{2}">\n                        hours:minutes\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <label>\n                            <input type="radio" name="mode" value="${n}" ${r===n?"checked":""}>\n                            Max-out duration of best options first.\n                            <br/><span class="hint">(recommended if you'll be afk)</span>\n                        </label>\n                    </td>\n                </tr>\n                <tr>\n                    <td>\n                        <label>\n                            <input type="radio" name="mode" value="${o}" ${r===o?"checked":""}>\n                            Aim for same duration across all options.\n                            <br/><span class="hint">(recommended if you can immediately resend whenever)</span>\n                        </label>    \n                    </td>\n                </tr>\n            </table>\n        `}createOptionsSectionHtml(){return`\n            <table class="vis options-section">\n                <tr><th colspan="2">Options to use</th></tr>\n                ${[...this.scavengeOptions.values()].map(e=>this.createOptionRowHtml(e)).join("")}\n            </table>\n        `}createOptionRowHtml(e){let t="";return this.preferences.isOptionAllowed(e.id)&&(t="checked"),`<tr>\n            <td>\n                <label>\n                    <input type="checkbox" ${t} data-option-id="${e.id}">\n                    <img src="${d.scavengeOption(e.id)}">\n                    <span>${e.getName()}</span>\n                </label>\n            </td>\n            <td>(${e.getLootPercent()}% carry capacity)</td>\n        </tr>`}createTroopsSectionHtml(){let e=["Reserved troops won't be sent scavenging.","<br/>","<br/>Example:"," :: You have 500 spears and 100 are reserved. At most, 400 spears would be sent scavenging."].join("");return`\n            <table class="vis troops-section">\n                <tr>\n                    <th>Use</th>\n                    <th>Reserved <img src="${d.info}" title="${e}" class="tooltip info"></th>\n                </tr>\n                ${this.sendableTroopTypes.map(e=>this.createTroopRowHtml(e)).join("")}\n            </table>\n        `}createTroopRowHtml(e){let t=this.preferences.isTroopTypeAllowed(e)?"checked":"",s=this.preferences.getReservedCount(e);return`<tr>\n            <td>\n                <input class="troop-allowed" type="checkbox" value="${e}" ${t}>\n                <img src="${d.troopIcon(e)}">\n            </td>\n            <td><input class="troop-reserved" data-troop-type="${e}" type="number" min="0" value="${s}"></td>\n        </tr>`}createTroopsOrderSectionHtml(){let e=["Troops in upper groups will be sent before troops in lower groups.","<br/>","<br/>Troops within the same group will be split proportionally by count available."].join("");return`\n            <table class="vis troop-order-section">\n                <tr>\n                    <th>Order <img src="${d.info}" title="${e}" class="tooltip info"></th>\n                </tr>\n                ${this.sendableTroopTypes.map(()=>'<tr><td><div class="troop-group"></div></td></tr>').join("")}\n            </table>\n        `}initTroopOrder(){for(let[e,t]of Object.entries(this.preferences.troopOrder)){let s=this.$troopGroups.eq(e);for(let e of t){if(!v.existsOnWorld(e))continue;let t=$(`<img class="troop" draggable="true" data-troop-type="${e}" src="${d.troopIcon(e)}">`);s.append(t)}}let e;this.$troopGroups.on("dragover",function(e){e.preventDefault()}).on("dragenter",function(e){$(this).addClass("dragging-over")}).on("dragleave",function(e){$(this).removeClass("dragging-over")}).on("drop",function(s){s.preventDefault(),$(this).append(e),$(this).removeClass("dragging-over"),t()}),this.$troopGroups.find(".troop").on("dragstart",function(t){let s=t.originalEvent.dataTransfer;e=$(this),s.setDragImage(e.clone()[0],0,0),s.dropEffect="move",e.addClass("dragging")}).on("dragend",function(t){e.removeClass("dragging"),e=null});let t=()=>{let e=s();this.preferences.setTroopOrder(e)},s=()=>{let e=[];return this.$troopGroups.each(function(){let t=$(this).find(".troop");if(t.length<1)return;let s=[];t.each(function(){s.push($(this).data("troopType"))}),e.push(s)}),e}}watchSelf(){let e=this.preferences;this.$targetDuration.on("change",function(){if(!this.checkValidity())return;let[,t,s]=this.value.match(/(\d+):(\d+)/),r=3600*parseInt(t)+60*parseInt(s);r<3600?this.setCustomValidity("must be at least 1 hour"):(this.setCustomValidity(""),e.setTargetDuration(r))}),this.$options.on("change",function(){let t=$(this);e.setOptionAllowed(t.data("optionId"),t.prop("checked"))}),this.$modes.on("change",()=>{let t=this.$modes.filter(":checked").val();e.setMode(t)}),this.$troopsAllowed.on("change",function(){let t=$(this);e.setTroopAllowed(t.val(),t.prop("checked"))}),this.$troopsReserved.on("input",function(){if(!this.checkValidity())return;let t=parseInt(this.value)||0;e.setReservedCount(this.dataset.troopType,t)})}}f("\n\n    .twcheese-scavenge-preferences-widget .options-section,\n    .twcheese-scavenge-preferences-widget .timing-section,\n    .twcheese-scavenge-preferences-widget .troops-section,\n    .twcheese-scavenge-preferences-widget .troop-order-section {\n        width: 100%;\n    }\n\n    \n    .twcheese-scavenge-preferences-widget .info {\n        width: 14px;\n        height: 14px;\n        vertical-align: middle;\n        position: relative;\n        top: -1px;\n    }\n\n    .twcheese-scavenge-preferences-widget .target-duration {\n        width: 50px;\n    }\n\n    .twcheese-scavenge-preferences-widget .timing-section .hint {\n        font-size: x-small;\n        margin-left: 25px;\n    }\n\n    .twcheese-scavenge-preferences-widget .timing-section input[type='radio'] {\n        vertical-align: middle;\n    }\n\n    .twcheese-scavenge-preferences-widget .options-section td {\n        height: 22px;\n    }\n\n    .twcheese-scavenge-preferences-widget .options-section input,\n    .twcheese-scavenge-preferences-widget .options-section span {\n        vertical-align: middle;\n    }\n\n    .twcheese-scavenge-preferences-widget .options-section img {\n        vertical-align: middle;\n        width: 18px;\n        height: 18px;\n    }\n\n    .twcheese-scavenge-preferences-widget .troops-section td,\n    .twcheese-scavenge-preferences-widget .troop-order-section td {\n        height: 26px;\n    }\n\n    .twcheese-scavenge-preferences-widget .troops-section td:first-child {\n        width: 45px;\n    }   \n\n    .twcheese-scavenge-preferences-widget .troops-section img,\n    .twcheese-scavenge-preferences-widget .troops-section input {\n        vertical-align: middle;\n    }\n\n    .twcheese-scavenge-preferences-widget .troop-reserved {\n        width: 70px;\n    }\n\n    .twcheese-scavenge-preferences-widget .troop-group {\n        position: relative;\n        border: 1px solid black;\n        border-radius: 3px;\n        height: 18px;\n        width: 176px;\n        padding: 3px;\n    }\n\n    .twcheese-scavenge-preferences-widget .troop-group.dragging-over {\n        background-color: darkOrange;\n    }\n\n    .twcheese-scavenge-preferences-widget .troop {\n        display: inline-block;\n        width: 18px;\n        height: 18px;\n        cursor: move;\n        margin: 0 3px;\n        -webkit-user-select: none;\n        -moz-user-select: none;\n        -ms-user-select: none;\n        user-select: none;\n    }\n\n    .twcheese-scavenge-preferences-widget .troop.dragging {\n        opacity: 0.1;\n    }\n    \n");var x=s(3);let R,k,I,N={phases:[{type:"PhaseQuestion",internalName:"Entry",questions:[{type:"QuestionFreeForm",ask:"What's broken?",placeholderText:'e.g. "it doesn\'t focus the Start button"',minResponseLength:10}]}]},U=!1;function M(e=!0){let t=function(e){let t=[];return $(e).find(".scavenge-option").has(".free_send_button:not(.btn-disabled)").each(function(){let[,e]=$(this).find(".portrait").css("background-image").match(/options\/(\d).png/);t.push(parseInt(e))}),t}(document);if((t=k.adjustUsableOptionIds(t)).length<1)return void(e&&window.UI.ErrorMessage("Can't scavenge right now because there's no usable options"));let s=function(e){let t=new E;return $(e).find(".units-entry-all").each(function(){let e=this.dataset.unit;t[e]=parseInt(this.innerHTML.match(/\d+/)[0])}),t}(document);if(!k.areTroopsSufficient(s))return void(e&&window.UI.ErrorMessage("Not enough troops available to scavenge right now"));let r=k.assignTroops(t,s,R),n=t[t.length-1];r.get(n).each(function(e,t){$(`.unitsInput[name='${e}']`).val(t).trigger("change")}),function(e){$(".free_send_button")[e-1].focus()}(n)}let F=new x.a({});window.TwCheese.registerTool({id:"ASS",use:async function(){!function(){let e=document.location.href;return e.includes("screen=place")&&e.includes("mode=scavenge")}()?function(e){let{message:t,screen:s,screenName:r,uriParams:n,skippableId:o}=e;if(t=t||"{{Some genius forgot to write a message here}}",r=r||"{{Screen Name goes here}}",n=n||{},!s)throw Error("screen must be specified!");if(o&&a.get(m(o),!1))return window.UI.InfoMessage(`Redirecting to <strong>${r}</strong>...`),void setTimeout(()=>window.TribalWars.redirect(s,n),200);let i={text:"Take me there!",callback:()=>{if(o){let e=$("#twcheese-suggest-redirect-skip").prop("checked");a.set(m(o),e)}window.TribalWars.redirect(s,n)},confirm:!0};window.UI.ConfirmationBox(function(e,t){let s=e;return t.skippableId&&(s+='<div class="twcheese-suggest-redirect-skip-container">\n            <input id="twcheese-suggest-redirect-skip" type="checkbox">\n            <span>Don\'t ask, just take me there next time.</span>\n        </div>'),s}(t,e),[i,{text:"Whatever...",callback:()=>{}}],"twcheese_suggest_redirect",!0,!0)}({message:"To use this, you must be at the scavenging screen.",screen:"place",screenName:"Scavenging Screen",uriParams:{mode:"scavenge"},skippableId:"Tool:ASS"}):(U||(await async function(){await async function(){await Promise.all([c.ensureUpdated(),u.ensureUpdated(),l.ensureUpdated()])}();let e=y(document);k=new C(e.options,e.sendableTroopTypes,v),R=e.haulFactor;let t=a.get("ASS.troopsAssigner");t&&k.preferences.import(t),$(k.preferences).on("change",function(){a.set("ASS.troopsAssigner",k.preferences.export())}),I=e.options,function(){let e=$('<a href="#">&raquo; preferences</a>').css({fontSize:"small",marginLeft:"10px"}).on("click",function(e){e.preventDefault(),function(){let e=M;Dialog.show("twcheese-scavenge-preferences-popup",function(e){let t=new D(k.preferences,I,k.sendableTroopTypes);t.appendTo(e)},e)}()});$("#content_value").find("h3").eq(0).append(e)}(),function(){let e=$('<span>Script created by <a href="https://forum.tribalwars.net/index.php?members/28484">cheesasaurus</a> and maintained by <a target="_blank" href="https://www.github.com/Jopika">Jopika</a></span>').css({float:"right",fontSize:"xx-small",fontWeight:"normal"});$("#content_value").find("h3").eq(0).append(e)}(),f("\n        .free_send_button:focus {\n            color: yellow;\n            box-shadow: 0 0 5px 3px yellow;\n        }\n    "),function(e){let t=new MutationObserver(function(t){t.forEach(function(t){let s=$(t.addedNodes).is(".active-view");s&&e()})});$(".scavenge-option").each(function(){t.observe(this,{childList:!0,subtree:!0})})}(()=>M(!1))}(),U=!0),M())},getDebugProcess:function(){return F.create("Tool: Another Scavenging Script",N,!0)}})}]);
//# sourceMappingURL=https://jopika.github.io/twcheese/dist/tool/setup-only/sourcemaps/ASS.min.js.map
